<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÌîºÏïÑÎÖ∏ ÏãúÏ∞Ω Ïó∞Ïäµ: MIDI Î¶¨Îì¨ Í≤åÏûÑ</title>
    <!-- Tone.js MIDI Î°úÎçî -->
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        body {
            background-color: #1e1e1e;
            color: #fff;
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            box-sizing: border-box;
            cursor: default;
            position: relative; 
        }

        /* Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        #controls {
            flex-shrink: 0; 
            background: #2c2c2c;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            gap: 8px; 
            align-items: center;
            flex-wrap: wrap; 
            justify-content: center; 
            z-index: 20;
            width: 100%;
            box-sizing: border-box;
            transition: opacity 0.3s;
            min-height: 60px;
        }

        .hidden-controls {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            top: -100px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #3a3a3a;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 13px;
            white-space: nowrap; 
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-upload input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .legend {
            display: flex;
            gap: 8px;
            font-size: 11px;
            margin-left: 5px;
            flex-wrap: wrap; 
            justify-content: center;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 2px; }

        label {
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        button {
            background: #00d2ff;
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.1s;
            white-space: nowrap;
        }

        button.zoom-btn {
            padding: 5px 10px;
            font-size: 16px;
            background: #555;
            color: #fff;
        }

        button:active {
            transform: scale(0.95);
        }

        button.stop {
            background: #ff4757;
            color: white;
        }

        input[type="checkbox"] {
            accent-color: #00d2ff;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        select {
            background: #555;
            color: white;
            border: none;
            padding: 5px;
            border-radius: 4px;
            font-size: 13px;
            max-width: 140px; 
            cursor: pointer;
        }
        
        input[type="range"] {
            width: 60px;
            cursor: pointer;
        }

        /* Í≤åÏûÑ ÏòÅÏó≠ (Ïä§ÌÅ¨Î°§ Í∞ÄÎä•) */
        #game-wrapper {
            flex-grow: 1; 
            width: 100%;
            height: 100%; 
            overflow: auto; 
            display: flex; 
            position: relative;
            background: #1e1e1e;
            padding: 0; 
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch; 
            touch-action: pan-x; 
        }

        #game-container {
            position: relative;
            max-width: none; 
            height: 100%; 
            background: #000;
            box-shadow: none;
            transition: none; 
            flex-shrink: 0; 
            margin: 0; 
            transform-origin: 0 0;
            cursor: grab;
        }

        #game-container:active {
            cursor: grabbing;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #status-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(16px, 4vw, 24px);
            color: #aaa;
            pointer-events: none;
            text-align: center;
            width: 100%;
            white-space: pre-line;
            line-height: 1.5;
            z-index: 10;
        }

        /* ÌôîÎ©¥ Ï§ëÏïô Í≥†Ï†ï Í∞ÄÏù¥ÎìúÎùºÏù∏ */
        #center-guide {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 1px dashed rgba(255, 255, 255, 0.3);
            z-index: 15;
            pointer-events: none;
        }
        
        #game-wrapper::-webkit-scrollbar { width: 10px; height: 10px; }
        #game-wrapper::-webkit-scrollbar-track { background: #2c2c2c; }
        #game-wrapper::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; border: 2px solid #2c2c2c; }
        #game-wrapper::-webkit-scrollbar-corner { background: #2c2c2c; }
    </style>
</head>
<body>

    <div id="controls">
        <div class="control-group">
            <div class="file-upload">
                <button>üìÇ MIDI Ïó¥Í∏∞</button>
                <input type="file" id="midi-input" accept=".mid,.midi">
            </div>
            <span id="file-name-display" style="font-size: 12px; color: #ccc; margin-left: 5px; max-width: 100px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; display: none;"></span>
        </div>

        <div class="control-group">
            <label>ÏÉòÌîå:</label>
            <select id="sel-sample">
                <option value="default">Í∏∞Î≥∏ (Î∞òÏßùÎ∞òÏßù Ï†ÑÍ≥°)</option>
                <option value="sample1">ÏÉòÌîå 1 (ÌïôÍµêÏ¢Ö Ï†ÑÍ≥°)</option>
                <option value="sample2">ÏÉòÌîå 2 (ÎπÑÌñâÍ∏∞)</option>
                <option value="upload_hint">ÌååÏùº ÏóÖÎ°úÎìú...</option>
            </select>
        </div>

        <button id="btn-play">‚ñ∂ Ïû¨ÏÉù</button>
        <button id="btn-stop" class="stop">‚ñ† Ï†ïÏßÄ/Ïû¨ÏÑ§Ï†ï</button>
        
        <div class="control-group">
            <label>ÌôîÎ©¥:</label>
            <button class="zoom-btn" id="btn-zoom-out" title="Ï∂ïÏÜå">Ôºç</button>
            <span id="zoom-level" style="min-width: 40px; text-align: center; cursor:pointer;" title="ÌÅ¥Î¶≠Ïãú ÏûêÎèô ÎßûÏ∂§">100%</span>
            <button class="zoom-btn" id="btn-zoom-in" title="ÌôïÎåÄ">Ôºã</button>
        </div>

        <div class="control-group">
            <label>Íµ¨Í∞Ñ:</label>
            <select id="sel-section">
                <option value="-1">Ï†ÑÍ≥°</option>
            </select>
        </div>

        <div class="control-group">
            <label><input type="checkbox" id="chk-right" checked> R</label>
            <label><input type="checkbox" id="chk-left" checked> L</label>
            <label id="midi-status-icon" style="color:red; cursor:help;" title="MIDI Í∏∞Í∏∞ Ïó∞Í≤∞ ÏÉÅÌÉú">&#9679;</label>
        </div>

        <div class="control-group">
            <label>Î∞òÎ≥µ:</label>
            <select id="sel-repeat">
                <option value="0">ÏóÜÏùå</option>
                <option value="1">1Ìöå</option>
                <option value="2">2Ìöå</option>
                <option value="3">3Ìöå</option>
                <option value="4">4Ìöå</option>
                <option value="5">5Ìöå</option>
            </select>
        </div>

        <div class="control-group">
            <label>ÏÜçÎèÑ:</label>
            <input type="range" id="rng-speed" min="0.5" max="1.5" step="0.1" value="1.0">
            <span id="txt-speed">1.0x</span>
        </div>

        <div class="control-group legend">
            <div title="Left Pinky / Right Thumb"><span class="dot" style="background:#ff4444;"></span>L5/R1</div>
            <div title="Left Ring / Right Index"><span class="dot" style="background:#ffeb3b;"></span>L4/R2</div>
            <div title="Left Middle / Right Middle"><span class="dot" style="background:#00e676;"></span>L3/R3</div>
            <div title="Left Index / Right Ring"><span class="dot" style="background:#536dfe;"></span>L2/R4</div>
            <div title="Left Thumb / Right Pinky"><span class="dot" style="background:#d05ce3;"></span>L1/R5</div>
        </div>
    </div>

    <!-- ÌôîÎ©¥ Ï§ëÏïô Í≥†Ï†ï Í∞ÄÏù¥ÎìúÎùºÏù∏ -->
    <div id="center-guide"></div>

    <div id="game-wrapper">
        <div id="game-container">
            <canvas id="pianoCanvas"></canvas>
            <div id="status-msg">MIDI ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÍ±∞ÎÇò<br>ÏÉòÌîåÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Ïó∞ÏäµÌïòÏÑ∏Ïöî</div>
        </div>
    </div>

    <script>
        // --- 1. Ï†ÑÏó≠ Î≥ÄÏàò Î∞è ÏÉÅÏàò Ï†ïÏùò ---
        const canvas = document.getElementById('pianoCanvas');
        const ctx = canvas.getContext('2d');
        const statusMsg = document.getElementById('status-msg');
        const playBtn = document.getElementById('btn-play');
        const gameContainer = document.getElementById('game-container');
        const gameWrapper = document.getElementById('game-wrapper'); 
        const zoomLevelDisplay = document.getElementById('zoom-level');
        const midiInput = document.getElementById('midi-input');
        const sectionSelect = document.getElementById('sel-section');
        const sampleSelect = document.getElementById('sel-sample');
        const controlsDiv = document.getElementById('controls');
        const speedRange = document.getElementById('rng-speed');
        const speedText = document.getElementById('txt-speed');
        const midiStatusIcon = document.getElementById('midi-status-icon');
        const fileNameDisplay = document.getElementById('file-name-display');

        // Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï
        // [ÏµúÏ†ÅÌôî] ÌÉúÎ∏îÎ¶ø Îì± Í≥†Ìï¥ÏÉÅÎèÑ Í∏∞Í∏∞ÏóêÏÑú ÏÑ±Îä• Ï†ÄÌïòÎ•º ÎßâÍ∏∞ ÏúÑÌï¥ DPRÏùÑ ÏµúÎåÄ 2Î°ú Ï†úÌïú
        let dpr = Math.min(window.devicePixelRatio || 1, 2);
        let logicalWidth = 800;
        let logicalHeight = 600;

        // Í≤åÏûÑ ÏÑ§Ï†ï
        const fallingSpeed = 200; 
        const startOffset = 2.0; 
        const startNote = 21; 
        const endNote = 108;
        const SPLIT_NOTE = 60; 
        const BLACK_KEY_WIDTH_RATIO = 0.72 * 1.2; 
        const BLACK_KEY_HEIGHT_RATIO = 0.54 * 1.2;
        const keyHeight = 100;

        // ÏÉÅÌÉú Î≥ÄÏàò
        let currentZoom = 100;
        let baseWidth = 1000; 
        let audioCtx = null;
        let masterGain = null;
        let isPlaying = false;
        let isPaused = false;
        let pauseTime = 0;
        let startTime = 0;
        let animationId;
        let speed = 1.0;
        let currentLoop = 0;
        let loopCount = 0;
        
        let notes = []; 
        let currentSection = null; 
        let songDuration = 0;
        let isDefaultSong = true;
        let currentSongSections = []; // ÌòÑÏû¨ Í≥°Ïùò Íµ¨Í∞Ñ Ï†ïÎ≥¥
        
        let measureTimes = []; 
        let detectedTimeSignature = [4, 4]; 
        let detectedBpm = 120; 

        // MIDI ÏûÖÎ†• ÏÉÅÌÉú
        let currentPressedNotes = []; 
        let nextNoteIndex = 0; 
        const timingTolerance = 0.2; 
        let score = { correct: 0, missed: 0, total: 0 };
        const midiOutputs = []; 
        const midiInputs = [];

        const COLORS = {
            RED: '#ff4444',
            YELLOW: '#ffeb3b',
            GREEN: '#00e676',
            BLUE: '#536dfe',
            PURPLE: '#d05ce3',
            MISS: '#ff1493', 
            CORRECT: '#00d2ff' 
        };

        const FINGER_COLOR_MAP = {
            1: COLORS.RED, 2: COLORS.YELLOW, 3: COLORS.GREEN, 4: COLORS.BLUE, 5: COLORS.PURPLE
        };

        // ÏôºÏÜêÏö© Ïª¨Îü¨Îßµ (5Î≤àÏù¥ Îπ®Í∞ï, 1Î≤àÏù¥ Î≥¥Îùº)
        const LEFT_FINGER_COLOR_MAP = {
            5: COLORS.RED, 4: COLORS.YELLOW, 3: COLORS.GREEN, 2: COLORS.BLUE, 1: COLORS.PURPLE
        };

        const FINGER_OFFSETS = { 1: -4, 2: -2, 3: 0, 4: 2, 5: 4 };

        const BYPASS_CHANNEL_MAP = {
            0: { hand: 'left', finger: 1, color: LEFT_FINGER_COLOR_MAP[1] },
            1: { hand: 'left', finger: 2, color: LEFT_FINGER_COLOR_MAP[2] },
            2: { hand: 'left', finger: 3, color: LEFT_FINGER_COLOR_MAP[3] },
            3: { hand: 'left', finger: 4, color: LEFT_FINGER_COLOR_MAP[4] },
            4: { hand: 'left', finger: 5, color: LEFT_FINGER_COLOR_MAP[5] },
            5: { hand: 'right', finger: 1, color: FINGER_COLOR_MAP[1] },
            6: { hand: 'right', finger: 2, color: FINGER_COLOR_MAP[2] },
            7: { hand: 'right', finger: 3, color: FINGER_COLOR_MAP[3] },
            8: { hand: 'right', finger: 4, color: FINGER_COLOR_MAP[4] },
            10: { hand: 'right', finger: 5, color: FINGER_COLOR_MAP[5] }
        };

        const noteNamesList = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNoteNamesList = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

        // --- ÏÉòÌîå Í≥° Îç∞Ïù¥ÌÑ∞ (ÎÇ¥Ïû•) ---
        
        // 1. Î∞òÏßùÎ∞òÏßù ÏûëÏùÄÎ≥Ñ (Twinkle Twinkle) - Ï†ÑÍ≥° (12ÎßàÎîî)
        const rawDefaultNotes = [
            // --- 1Ïß∏Ï§Ñ (AÌååÌä∏: Theme) ---
            { note: 72, time: 0.0, dur: 0.5, hand: 'right', finger: 1, color: COLORS.RED },
            { note: 72, time: 0.5, dur: 0.5, hand: 'right', finger: 1, color: COLORS.RED },
            { note: 79, time: 1.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 1.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 2.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 2.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 3.0, dur: 1.0, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 77, time: 4.0, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 77, time: 4.5, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 76, time: 5.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 5.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 6.0, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 74, time: 6.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 72, time: 7.0, dur: 1.0, hand: 'right', finger: 1, color: COLORS.RED },
            // ÏôºÏÜê 1Ïß∏Ï§Ñ
            { note: 48, time: 0.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 0.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 0.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 48, time: 1.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 1.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 1.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 41, time: 2.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 45, time: 2.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 48, time: 2.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 3.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 3.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 3.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 41, time: 4.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 45, time: 4.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 48, time: 4.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 5.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 5.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 5.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 43, time: 6.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 47, time: 6.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 50, time: 6.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 7.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 7.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 7.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            // --- 2Ïß∏Ï§Ñ ---
            { note: 79, time: 8.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 8.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 77, time: 9.0, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 77, time: 9.5, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 76, time: 10.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 10.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 11.0, dur: 1.0, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 79, time: 12.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 12.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 77, time: 13.0, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 77, time: 13.5, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 76, time: 14.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 14.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 15.0, dur: 1.0, hand: 'right', finger: 2, color: COLORS.YELLOW },
            // ÏôºÏÜê 2Ïß∏Ï§Ñ
            { note: 48, time: 8.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 8.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 8.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 43, time: 9.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 47, time: 9.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 50, time: 9.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 10.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 10.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 10.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 43, time: 11.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 47, time: 11.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 50, time: 11.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 12.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 12.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 12.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 43, time: 13.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 47, time: 13.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 50, time: 13.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 14.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 14.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 14.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 43, time: 15.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 47, time: 15.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 50, time: 15.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            // --- 3Ïß∏Ï§Ñ ---
            { note: 72, time: 16.0, dur: 0.5, hand: 'right', finger: 1, color: COLORS.RED },
            { note: 72, time: 16.5, dur: 0.5, hand: 'right', finger: 1, color: COLORS.RED },
            { note: 79, time: 17.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 17.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 18.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 18.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 19.0, dur: 1.0, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 77, time: 20.0, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 77, time: 20.5, dur: 0.5, hand: 'right', finger: 4, color: COLORS.BLUE },
            { note: 76, time: 21.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 21.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 22.0, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 74, time: 22.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 72, time: 23.0, dur: 1.0, hand: 'right', finger: 1, color: COLORS.RED },
            // ÏôºÏÜê 3Ïß∏Ï§Ñ
            { note: 48, time: 16.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 16.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 16.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 48, time: 17.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 17.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 17.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 41, time: 18.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 45, time: 18.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 48, time: 18.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 19.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 19.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 19.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 41, time: 20.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 45, time: 20.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 48, time: 20.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 21.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 21.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 21.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 43, time: 22.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 47, time: 22.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 50, time: 22.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            { note: 48, time: 23.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 23.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN },
            { note: 55, time: 23.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
        ];

        // 2. ÌïôÍµêÏ¢Ö (School Bell) - Ï†ÑÍ≥° (8ÎßàÎîî, 2Ï§Ñ)
        const sample1Notes = [
            // --- 1Ïß∏Ï§Ñ ---
            // M1: ÏÜîÏÜîÎùºÎùº (C5 Ïò•ÌÉÄÎ∏å)
            { note: 79, time: 0.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 0.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 1.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 1.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            // M2: ÏÜîÏÜîÎØ∏
            { note: 79, time: 2.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 2.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 76, time: 3.0, dur: 1.0, hand: 'right', finger: 3, color: COLORS.GREEN },
            // M3: ÏÜîÏÜîÎØ∏ÎØ∏
            { note: 79, time: 4.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 4.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 76, time: 5.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 5.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            // M4: Î†à (2Î∞ï)
            { note: 74, time: 6.0, dur: 2.0, hand: 'right', finger: 2, color: COLORS.YELLOW },

            // ÏôºÏÜê 1Ïß∏Ï§Ñ (C-C-C-G) - 3ÌôîÏùå Root Position (C3, G2)
            // M1: C Major (C3 E3 G3)
            { note: 48, time: 0.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 0.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 0.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 1.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 1.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 1.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M2: C Major
            { note: 48, time: 2.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 2.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 2.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 3.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 3.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 3.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M3: C Major
            { note: 48, time: 4.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 4.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 4.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 5.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 5.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 5.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M4: G Major (G2 B2 D3)
            { note: 43, time: 6.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 6.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 6.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 43, time: 7.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 7.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 7.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 

            // --- 2Ïß∏Ï§Ñ ---
            // M5: ÏÜîÏÜîÎùºÎùº
            { note: 79, time: 8.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 8.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 9.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 81, time: 9.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            // M6: ÏÜîÏÜîÎØ∏
            { note: 79, time: 10.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 10.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 76, time: 11.0, dur: 1.0, hand: 'right', finger: 3, color: COLORS.GREEN },
            // M7: ÏÜîÎØ∏Î†àÎØ∏
            { note: 79, time: 12.0, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 76, time: 12.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 13.0, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 76, time: 13.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            // M8: ÎèÑ (2Î∞ï)
            { note: 72, time: 14.0, dur: 2.0, hand: 'right', finger: 1, color: COLORS.RED },

            // ÏôºÏÜê 2Ïß∏Ï§Ñ (C-C-G-C)
            // M5: C Major
            { note: 48, time: 8.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 8.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 8.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 9.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 9.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 9.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M6: C Major
            { note: 48, time: 10.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 10.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 10.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 11.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 11.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 11.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M7: G Major
            { note: 43, time: 12.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 12.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 12.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 43, time: 13.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 13.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 13.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            // M8: C Major
            { note: 48, time: 14.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 14.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 14.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 15.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 15.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 15.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
        ];

        // 3. ÎπÑÌñâÍ∏∞ (Airplane) - Ï†ÑÍ≥° (8ÎßàÎîî)
        const sample2Notes = [
            // --- 1Ïß∏Ï§Ñ ---
            // M1: ÎØ∏Î†àÎèÑÎ†à (E5 D5 C5 D5)
            { note: 76, time: 0.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 0.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 72, time: 1.0, dur: 0.5, hand: 'right', finger: 1, color: COLORS.RED },
            { note: 74, time: 1.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            // M2: ÎØ∏ÎØ∏ÎØ∏ (E5 E5 E5)
            { note: 76, time: 2.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 2.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 3.0, dur: 1.0, hand: 'right', finger: 3, color: COLORS.GREEN },
            // M3: Î†àÎ†àÎ†à (D5 D5 D5)
            { note: 74, time: 4.0, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 74, time: 4.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 74, time: 5.0, dur: 1.0, hand: 'right', finger: 2, color: COLORS.YELLOW },
            // M4: ÎØ∏ÏÜîÏÜî (E5 G5 G5)
            { note: 76, time: 6.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 79, time: 6.5, dur: 0.5, hand: 'right', finger: 5, color: COLORS.PURPLE },
            { note: 79, time: 7.0, dur: 1.0, hand: 'right', finger: 5, color: COLORS.PURPLE },

            // ÏôºÏÜê 1Ïß∏Ï§Ñ (C-C-G-C) - 3ÌôîÏùå Root Position
            // M1: C Major (C3 E3 G3)
            { note: 48, time: 0.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 0.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 0.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 1.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 1.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 1.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M2: C Major
            { note: 48, time: 2.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 2.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 2.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 3.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 3.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 3.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M3: G Major (G2 B2 D3)
            { note: 43, time: 4.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 4.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 4.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 43, time: 5.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 5.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 5.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            // M4: C Major
            { note: 48, time: 6.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 6.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 6.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 7.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 7.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 7.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   

            // --- 2Ïß∏Ï§Ñ ---
            // M5: ÎØ∏Î†àÎèÑÎ†à
            { note: 76, time: 8.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 8.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 72, time: 9.0, dur: 0.5, hand: 'right', finger: 1, color: COLORS.RED },
            { note: 74, time: 9.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            // M6: ÎØ∏ÎØ∏ÎØ∏
            { note: 76, time: 10.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 10.5, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 76, time: 11.0, dur: 1.0, hand: 'right', finger: 3, color: COLORS.GREEN },
            // M7: Î†àÎ†àÎØ∏Î†à
            { note: 74, time: 12.0, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 74, time: 12.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            { note: 76, time: 13.0, dur: 0.5, hand: 'right', finger: 3, color: COLORS.GREEN },
            { note: 74, time: 13.5, dur: 0.5, hand: 'right', finger: 2, color: COLORS.YELLOW },
            // M8: ÎèÑ
            { note: 72, time: 14.0, dur: 2.0, hand: 'right', finger: 1, color: COLORS.RED },

            // ÏôºÏÜê 2Ïß∏Ï§Ñ (C-C-G-C)
            // M5: C Major
            { note: 48, time: 8.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 8.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 8.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 9.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 9.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 9.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M6: C Major
            { note: 48, time: 10.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 10.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 10.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 11.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 11.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 11.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            // M7: G Major
            { note: 43, time: 12.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 12.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 12.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE }, 
            { note: 43, time: 13.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED },
            { note: 47, time: 13.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 50, time: 13.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },
            // M8: C Major
            { note: 48, time: 14.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 14.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 14.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
            { note: 48, time: 15.0, dur: 1.0, hand: 'left', finger: 5, color: COLORS.RED }, 
            { note: 52, time: 15.0, dur: 1.0, hand: 'left', finger: 3, color: COLORS.GREEN }, 
            { note: 55, time: 15.0, dur: 1.0, hand: 'left', finger: 1, color: COLORS.PURPLE },   
        ];


        // --- 2. Ïú†Ìã∏Î¶¨Ìã∞ Î∞è Ìó¨Ìçº Ìï®Ïàò ---

        function getNoteName(midi) { return noteNamesList[midi % 12]; }
        function getFlatNoteName(midi) { return flatNoteNamesList[midi % 12]; }
        function midiToFreq(note) { return 440 * Math.pow(2, (note - 69) / 12); }

        function isWhiteKey(midi) {
            const note = midi % 12;
            return [0, 2, 4, 5, 7, 9, 11].includes(note);
        }

        let totalWhiteKeys = 0;
        for(let i = startNote; i < endNote; i++) {
            if(isWhiteKey(i)) totalWhiteKeys++;
        }

        function getNoteX(midi) {
            const keyW = logicalWidth / totalWhiteKeys;
            let whiteKeyCount = 0;
            for(let i = startNote; i < midi; i++) {
                if(isWhiteKey(i)) whiteKeyCount++;
            }
            if (!isWhiteKey(midi)) {
                return (whiteKeyCount * keyW) - (keyW * (BLACK_KEY_WIDTH_RATIO / 2)); 
            }
            return whiteKeyCount * keyW;
        }

        class HandState {
            constructor() {
                this.center = null;
                this.fingerEndTimes = { 1:0, 2:0, 3:0, 4:0, 5:0 };
            }
        }

        function chooseFinger(noteMidi, noteStartTime, noteDuration, handState) {
            let candidates = [];
            for (let f = 1; f <= 5; f++) {
                let offset = FINGER_OFFSETS[f];
                let candidateCenter = noteMidi - offset;
                let cost = 0;
                if (handState.center !== null) cost = Math.abs(candidateCenter - handState.center);
                candidates.push({ cost: cost, finger: f, center: candidateCenter });
            }
            candidates.sort((a, b) => a.cost - b.cost);
            let chosen = null;
            for (let c of candidates) {
                if (handState.fingerEndTimes[c.finger] <= noteStartTime + 0.05) {
                    chosen = c;
                    break;
                }
            }
            if (!chosen) chosen = candidates[0];
            handState.center = chosen.center;
            handState.fingerEndTimes[chosen.finger] = noteStartTime + noteDuration;
            return chosen.finger;
        }

        // --- 3. Web MIDI API Ï≤òÎ¶¨ ---

        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
        } else {
            midiStatusIcon.style.color = '#ff4757';
            midiStatusIcon.title = 'MIDI APIÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.';
        }

        function onMIDIFailure() {
            midiStatusIcon.style.color = '#ff4757';
            midiStatusIcon.title = 'MIDI Ïû•Ïπò Ïó∞Í≤∞ Ïã§Ìå®';
        }

        function onMIDISuccess(midiAccess) {
            midiAccess.onstatechange = onStateChange;
            updateMIDIStatus(midiAccess);
        }

        function onStateChange(event) {
            updateMIDIStatus(event.target);
        }

        function updateMIDIStatus(midiAccess) {
            midiInputs.length = 0;
            midiOutputs.length = 0;
            midiAccess.inputs.forEach(input => {
                midiInputs.push(input);
                input.onmidimessage = onMIDIMessage;
            });
            midiAccess.outputs.forEach(output => midiOutputs.push(output));

            if (midiInputs.length > 0) {
                midiStatusIcon.style.color = COLORS.GREEN;
                midiStatusIcon.title = `MIDI ÏûÖÎ†• Ïû•Ïπò Ïó∞Í≤∞Îê®: ${midiInputs.map(i => i.name).join(', ')}`;
            } else {
                midiStatusIcon.style.color = COLORS.YELLOW;
                midiStatusIcon.title = 'MIDI ÏûÖÎ†• Ïû•ÏπòÍ∞Ä Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.';
            }
        }
        
        function onMIDIMessage(event) {
            const command = event.data[0];
            const note = event.data[1];
            // const velocity = event.data[2]; 

            if (command >= 144 && command <= 159 && event.data[2] > 0) { // Note On
                handleNoteOn(note);
            } else if ((command >= 128 && command <= 143) || (command >= 144 && command <= 159 && event.data[2] === 0)) { // Note Off
                handleNoteOff(note);
            }
        }

        function handleNoteOn(note) {
            currentPressedNotes.push({ note: note, time: audioCtx ? audioCtx.currentTime : 0, color: '#aaa' });

            if (isPlaying && nextNoteIndex < notes.length) {
                const currentTime = getCurrentTime();
                const targetNote = notes[nextNoteIndex];
                
                const timeDiff = Math.abs(targetNote.startTime - currentTime);
                
                if (timeDiff <= timingTolerance) {
                    if (note === targetNote.note) {
                        targetNote.played = true; 
                        targetNote.scoreStatus = 'correct';
                        targetNote.color = COLORS.CORRECT; 
                        score.correct++;
                        nextNoteIndex++; 
                    } else {
                        score.missed++;
                        targetNote.scoreStatus = 'missed'; 
                        targetNote.color = COLORS.MISS; 
                        const pressedNote = currentPressedNotes.find(n => n.note === note);
                        if (pressedNote) pressedNote.color = COLORS.MISS;
                    }
                }
            }
            
            drawKeyboard(currentPressedNotes); // Ïù¥ Ìò∏Ï∂úÏùÄ ÏïÑÎûò loop Ìï®Ïàò ÎÇ¥ Ìò∏Ï∂úÎ°ú ÎåÄÏ≤¥Îê®
        }

        function handleNoteOff(note) {
            currentPressedNotes = currentPressedNotes.filter(n => n.note !== note);
            drawKeyboard(currentPressedNotes); // Ïù¥ Ìò∏Ï∂úÏùÄ ÏïÑÎûò loop Ìï®Ïàò ÎÇ¥ Ìò∏Ï∂úÎ°ú ÎåÄÏ≤¥Îê®
        }

        // --- 4. MIDI ÌååÏùº ÌååÏã± Î∞è Î°úÏßÅ ---
        
        midiInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                fileNameDisplay.innerText = file.name;
                fileNameDisplay.style.display = 'inline-block';
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const midi = new Midi(event.target.result);
                        isDefaultSong = false;
                        parseMidi(midi);
                    } catch (err) {
                        alert("MIDI ÌååÏùº ÌååÏã± Ïã§Ìå®: " + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // ÎÇ¥Î∂Ä Í≥° Î°úÎî© Ìï®Ïàò (ÌÜµÌï©)
        function loadInternalSong(songData, title, sections = []) {
            isDefaultSong = true;
            currentSongSections = sections; // ÌòÑÏû¨ Í≥°Ïùò Íµ¨Í∞Ñ Ï†ïÎ≥¥ Ï†ÄÏû•
            notes = JSON.parse(JSON.stringify(songData));
            notes.forEach(n => {
                n.startTime = n.time * 0.8 + startOffset; 
                n.durationTime = n.dur * 0.8;
                n.played = false; 
                n.scoreStatus = 'pending'; 
            });
            
            // ÎßàÏßÄÎßâ ÎÖ∏Ìä∏ Í∏∞Ï§ÄÏúºÎ°ú Ï¢ÖÎ£å ÏãúÍ∞Ñ Í≥ÑÏÇ∞
            const lastNote = notes[notes.length - 1];
            const lastNoteEnd = lastNote ? (lastNote.startTime + lastNote.durationTime) : 0;
            songDuration = lastNoteEnd + 0.5;

            updateSectionDropdown();
            stopGame(true);
            autoFitZoom();
            statusMsg.innerText = `${title} Î°úÎìú ÏôÑÎ£å!\nÏû¨ÏÉù Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏãúÏûëÌïòÏÑ∏Ïöî.`;
            statusMsg.style.display = 'block';
            fileNameDisplay.style.display = 'none';
        }

        // ÏÉòÌîå ÏÑ†ÌÉù Î¶¨Ïä§ÎÑà ÏàòÏ†ï
        sampleSelect.addEventListener('change', async (e) => {
            const value = e.target.value;
            if (value === 'default') {
                loadInternalSong(rawDefaultNotes, "Î∞òÏßùÎ∞òÏßù ÏûëÏùÄÎ≥Ñ", ["1Ïß∏Ï§Ñ (1-4ÎßàÎîî)", "2Ïß∏Ï§Ñ (5-8ÎßàÎîî)", "3Ïß∏Ï§Ñ (9-12ÎßàÎîî)"]);
            } else if (value === 'sample1') {
                loadInternalSong(sample1Notes, "ÌïôÍµêÏ¢Ö", ["1Ïß∏Ï§Ñ (1-4ÎßàÎîî)", "2Ïß∏Ï§Ñ (5-8ÎßàÎîî)"]);
            } else if (value === 'sample2') {
                loadInternalSong(sample2Notes, "ÎπÑÌñâÍ∏∞", ["1Ïß∏Ï§Ñ (1-4ÎßàÎîî)", "2Ïß∏Ï§Ñ (5-8ÎßàÎîî)"]);
            } else if (value === 'upload_hint') {
                alert("ÏúÑÏùò 'MIDI Ïó¥Í∏∞' Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÎÇ¥ Ïª¥Ìì®ÌÑ∞Ïùò ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                e.target.value = 'default';
            }
        });

        function calculateMeasureTimes(midi) {
            const ppq = midi.header.ppq;
            const timeSignatures = midi.header.timeSignatures; 
            const tempos = midi.header.tempos;
            
            let maxTick = 0;
            midi.tracks.forEach(t => {
                t.notes.forEach(n => {
                    if (n.ticks + n.durationTicks > maxTick) maxTick = n.ticks + n.durationTicks;
                });
            });

            let activeTS = timeSignatures[0] || { ticks: 0, timeSignature: [4, 4] };
            if (activeTS.ticks > 0) activeTS = { ticks: 0, timeSignature: [4, 4] };

            let currentTick = 0;
            let times = [];
            let tsIndex = 0;
            
            timeSignatures.sort((a,b) => a.ticks - b.ticks);

            while (currentTick < maxTick) {
                times.push(ticksToSeconds(currentTick, tempos, ppq));
                while(tsIndex < timeSignatures.length - 1 && timeSignatures[tsIndex + 1].ticks <= currentTick) {
                    tsIndex++;
                    activeTS = timeSignatures[tsIndex];
                }
                const num = activeTS.timeSignature[0];
                const den = activeTS.timeSignature[1];
                const ticksPerMeasure = (num * ppq) * (4 / den);
                currentTick += ticksPerMeasure;
                if (times.length > 2000) break; 
            }
            times.push(ticksToSeconds(currentTick, tempos, ppq));
            detectedTimeSignature = activeTS.timeSignature;
            if (tempos.length > 0) detectedBpm = Math.round(tempos[0].bpm);
            else detectedBpm = 120;
            return times;
        }

        function ticksToSeconds(tick, tempos, ppq) {
            let tempoEvent = tempos[0] || { ticks: 0, bpm: 120, time: 0 };
            for (let i = 1; i < tempos.length; i++) {
                if (tempos[i].ticks > tick) break;
                tempoEvent = tempos[i];
            }
            const deltaTicks = tick - tempoEvent.ticks;
            const secondsPerTick = 60 / (tempoEvent.bpm * ppq);
            return tempoEvent.time + (deltaTicks * secondsPerTick);
        }

        function parseMidi(midi, autoSplit = true) {
            // 1. Ï≤´ Î≤àÏß∏ ÎÖ∏Ìä∏Ïùò ÏãúÏûë ÏãúÍ∞Ñ Ï∞æÍ∏∞ (Í≥µÎ∞± Ï†úÍ±∞Ïö©)
            let firstNoteTime = Infinity;
            midi.tracks.forEach(track => {
                if (track.channel === 9) return; 
                track.notes.forEach(n => {
                    if (n.time < firstNoteTime) firstNoteTime = n.time;
                });
            });
            // ÎÖ∏Ìä∏Í∞Ä ÌïòÎÇòÎèÑ ÏóÜÎäî Í≤ΩÏö∞ Î∞©ÏßÄ
            if (firstNoteTime === Infinity) firstNoteTime = 0;

            const allNotes = [];
            midi.tracks.forEach(track => {
                track.notes.forEach(n => {
                    if (track.channel === 9) return; 
                    allNotes.push({
                        midi: n.midi,
                        // Ï≤´ Î≤àÏß∏ ÎÖ∏Ìä∏Í∞Ä 0Ï¥à(startOffset ÏßÄÏ†ê)Ïóê Ïò§ÎèÑÎ°ù ÏïûÎ∂ÄÎ∂Ñ Í≥µÎ∞± ÏãúÍ∞ÑÏùÑ Î∫å
                        startTime: (n.time - firstNoteTime) + startOffset,
                        duration: n.duration,
                        name: n.name,
                        channel: track.channel 
                    });
                });
            });

            allNotes.sort((a, b) => a.startTime - b.startTime);
            const processedNotes = [];

            if (autoSplit) {
                const leftHandState = new HandState();
                const rightHandState = new HandState();
                allNotes.forEach(n => {
                    let hand, finger, color;
                    if (n.midi < SPLIT_NOTE) {
                        hand = 'left';
                        finger = chooseFinger(n.midi, n.startTime, n.duration, leftHandState);
                        color = LEFT_FINGER_COLOR_MAP[finger]; // ÏôºÏÜêÏùÄ 5Î≤àÏù¥ Îπ®Í∞ï, 1Î≤àÏù¥ Î≥¥Îùº
                    } else {
                        hand = 'right';
                        finger = chooseFinger(n.midi, n.startTime, n.duration, rightHandState);
                        color = FINGER_COLOR_MAP[finger]; // Ïò§Î•∏ÏÜêÏùÄ 1Î≤àÏù¥ Îπ®Í∞ï, 5Î≤àÏù¥ Î≥¥Îùº
                    }
                    processedNotes.push({
                        note: n.midi,
                        startTime: n.startTime,
                        durationTime: n.duration,
                        hand: hand,
                        finger: finger,
                        color: color,
                        played: false
                    });
                });
            } else {
                allNotes.forEach(n => {
                    const mapData = BYPASS_CHANNEL_MAP[n.channel];
                    if (mapData) {
                        processedNotes.push({
                            note: n.midi,
                            startTime: n.startTime,
                            durationTime: n.duration,
                            hand: mapData.hand,
                            finger: mapData.finger,
                            color: mapData.color,
                            played: false
                        });
                    } else {
                        processedNotes.push({
                            note: n.midi,
                            startTime: n.startTime,
                            durationTime: n.duration,
                            hand: 'right', finger: '', color: '#888', played: false
                        });
                    }
                });
            }

            notes = processedNotes;
            
            // ÎßàÎîî ÏãúÍ∞Ñ Ïû¨Í≥ÑÏÇ∞ Î∞è Í≥µÎ∞± Ï†úÍ±∞ Ï†ÅÏö©
            const rawMeasureTimes = calculateMeasureTimes(midi);
            measureTimes = rawMeasureTimes.map(t => t - firstNoteTime).filter(t => t >= -1.0);
            if (measureTimes.length === 0 || measureTimes[0] > 1.0) {
                measureTimes.unshift(0);
            }
            
            const lastNote = notes[notes.length - 1];
            const lastNoteEnd = lastNote ? (lastNote.startTime + lastNote.durationTime) : 0;
            songDuration = lastNoteEnd + 0.5; 
            
            updateSectionDropdown();
            stopGame(true);
            autoFitZoom();
            
            const tsStr = detectedTimeSignature.join('/');
            const splitMsg = autoSplit ? "ÏûêÎèôÏúºÎ°ú ÏÜêÍ∞ÄÎùΩ Î≤àÌò∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§." : "ÏÉòÌîå Ï±ÑÎÑê ÏÑ§Ï†ï ÏÇ¨Ïö©";
            statusMsg.innerText = `MIDI Î∂ÑÏÑù ÏôÑÎ£å!\n(BPM: ${detectedBpm}, Î∞ïÏûê: ${tsStr})\n${splitMsg}`;
            statusMsg.style.display = 'block';
        }

        function loadDefaultSong() {
            // Ï¥àÍ∏∞ Î°úÎî©: Î∞òÏßùÎ∞òÏßù ÏûëÏùÄÎ≥Ñ
            loadInternalSong(rawDefaultNotes, "Î∞òÏßùÎ∞òÏßù ÏûëÏùÄÎ≥Ñ", ["1Ïß∏Ï§Ñ (1-4ÎßàÎîî)", "2Ïß∏Ï§Ñ (5-8ÎßàÎîî)", "3Ïß∏Ï§Ñ (9-12ÎßàÎîî)"]);
        }

        // --- 5. Î†åÎçîÎßÅ Ìï®Ïàò ---

        function drawFullHeightBeams(activeBeams) {
            const viewHeight = logicalHeight - keyHeight;
            const keyW = logicalWidth / totalWhiteKeys;
            const bWidth = keyW / 2.5;

            Object.keys(activeBeams).forEach(midi => {
                const info = activeBeams[midi];
                if (info.source === 'input') return;

                const x = getNoteX(midi);
                const beamX = x + (isWhiteKey(midi) ? keyW/2 : keyW*BLACK_KEY_WIDTH_RATIO/2) - (bWidth / 2);
                
                ctx.save();
                ctx.fillStyle = info.color || '#888';
                
                // [ÏµúÏ†ÅÌôî] shadowBlur Ï†úÍ±∞ (ÌÉúÎ∏îÎ¶ø ÏÑ±Îä• Ïù¥Ïäà Ìï¥Í≤∞)
                // ÎåÄÏã† globalCompositeOperation 'lighter'Î°ú ÎπõÎÇòÎäî Ìö®Í≥º Ïú†ÏßÄ
                if (info.status === 2) {
                    // Ïó∞Ï£º Ï§ë: ÏßÑÌïòÍ≥† Í∞ïÌïú Îπõ
                    ctx.globalAlpha = 0.6; 
                    // ctx.shadowBlur = 15;  <-- ÏÑ±Îä• Ï†ÄÌïò ÏõêÏù∏ Ï†úÍ±∞
                    // ctx.shadowColor = ctx.fillStyle;
                } else {
                    // Îñ®Ïñ¥ÏßÄÎäî Ï§ë: ÏòÖÏùÄ ÎÜçÎèÑ
                    ctx.globalAlpha = 0.3; 
                    // ctx.shadowBlur = 0;    
                    ctx.globalCompositeOperation = 'lighter'; 
                }
                ctx.fillRect(beamX, 0, bWidth, viewHeight);
                ctx.restore();
            });
        }

        function drawNotes(currentTime) {
            const viewHeight = logicalHeight - keyHeight;
            const keyW = logicalWidth / totalWhiteKeys;
            
            ctx.textAlign = 'center';
            // ctx.textBaselineÏùÄ Ï°∞Í±¥Î≥ÑÎ°ú ÏÑ§Ï†ïÌï©ÎãàÎã§.
            
            notes.forEach(n => {
                const showRight = document.getElementById('chk-right').checked;
                const showLeft = document.getElementById('chk-left').checked;
                if(n.hand === 'right' && !showRight) return;
                if(n.hand === 'left' && !showLeft) return;

                const timeDiff = n.startTime - currentTime;
                if (timeDiff + n.durationTime < -1) return;
                if (timeDiff * fallingSpeed > viewHeight) return;

                const y = viewHeight - (timeDiff * fallingSpeed);
                const height = Math.max(n.durationTime * fallingSpeed, 20); 
                const x = getNoteX(n.note);
                const width = isWhiteKey(n.note) ? keyW - 2 : keyW * BLACK_KEY_WIDTH_RATIO;
                
                // [ÏàòÏ†ï] Îë•Í∑º Î™®ÏÑúÎ¶¨(radius) Ï†úÍ±∞ÌïòÍ≥† ÏßÅÍ∞Å ÏÇ¨Í∞ÅÌòïÏúºÎ°ú Î≥ÄÍ≤Ω
                ctx.beginPath();
                ctx.rect(x, y - height, width, height - 2);
                ctx.save();
                ctx.clip();
                ctx.fillStyle = n.color || '#888';
                ctx.fill();
                ctx.restore();

                // ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ Í≤∞Ï†ï (ÎÖ∏Ìä∏ ÎÇ¥Î∂ÄÏö©)
                const innerTextColor = (n.color === COLORS.YELLOW || n.color === COLORS.GREEN) ? '#000' : '#fff';
                const noteName = getNoteName(n.note);
                const centerX = x + width / 2;

                if (n.finger) {
                    // ÏÜêÍ∞ÄÎùΩ Î≤àÌò∏Í∞Ä ÏûàÎäî Í≤ΩÏö∞
                    if (height < 35) {
                        // [ÏàòÏ†ï] ÏßßÏùÄ ÎÖ∏Ìä∏: ÏÜêÍ∞ÄÎùΩ Î≤àÌò∏Îäî ÎÇ¥Î∂Ä, ÏùåÏù¥Î¶ÑÏùÄ Ïô∏Î∂Ä ÏÉÅÎã®Ïóê ÌëúÏãú
                        
                        // 1. ÏÜêÍ∞ÄÎùΩ Î≤àÌò∏ (ÎÇ¥Î∂Ä Ï§ëÏïô)
                        ctx.fillStyle = innerTextColor;
                        ctx.font = 'bold 14px Arial';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(n.finger, centerX, y - height/2);

                        // 2. ÏùåÏù¥Î¶Ñ (Ïô∏Î∂Ä ÏÉÅÎã® - Ìï≠ÏÉÅ Ïà´Ïûê ÏúÑÏóê)
                        ctx.fillStyle = '#fff'; // Î∞∞Í≤ΩÏù¥ Í≤ÄÏ†ïÏù¥ÎØÄÎ°ú Ìù∞ÏÉâ
                        ctx.font = '12px Arial';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(noteName, centerX, y - height - 2); 
                    } else {
                        // Í∏¥ ÎÖ∏Ìä∏: ÎÇ¥Î∂Ä ÌïòÎã®Ïóê Îëò Îã§ ÌëúÏãú
                        ctx.fillStyle = innerTextColor;
                        
                        // ÏÜêÍ∞ÄÎùΩ Î≤àÌò∏
                        ctx.font = 'bold 20px Arial';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(n.finger, centerX, y - 2);
                        
                        // ÏùåÏù¥Î¶Ñ
                        ctx.font = '16px Arial';
                        ctx.fillText(noteName, centerX, y - 22);
                    }
                } else {
                    // ÏÜêÍ∞ÄÎùΩ Î≤àÌò∏Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
                    ctx.fillStyle = innerTextColor;
                    if (height < 35) {
                        ctx.font = 'bold 14px Arial';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(noteName, centerX, y - height/2);
                    } else {
                        ctx.font = 'bold 16px Arial';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(noteName, centerX, y - 2);
                    }
                }
            });
        }

        function drawKeyboard(keyVisuals) {
            const y = logicalHeight - keyHeight;
            const keyW = logicalWidth / totalWhiteKeys;

            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Ìù∞ Í±¥Î∞ò
            let whiteIndex = 0;
            for(let i = startNote; i < endNote; i++) {
                if(isWhiteKey(i)) {
                    const x = whiteIndex * keyW;
                    const visual = keyVisuals[i];
                    
                    // 1. Ìï≠ÏÉÅ Ìù∞ÏÉâ Î≤†Ïù¥Ïä§Î•º Î®ºÏ†Ä Í∑∏Î¶º (ÌååÏä§ÌÖîÌÜ§ Íµ¨ÌòÑÏùÑ ÏúÑÌï¥)
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(x, y, keyW - 1, keyHeight);

                    // 2. ÏãúÍ∞Å Ìö®Í≥º(ÏÉâÏÉÅ) ÎçßÏπ†
                    if(visual) {
                        ctx.save();
                        ctx.fillStyle = visual.color || COLORS.CORRECT;
                        
                        if (visual.status === 1) {
                            // [ÏàòÏ†ï] Îñ®Ïñ¥ÏßÄÎäî Ï§ë: Í∏∞Ï°¥ 0.25 -> 0.4Î°ú ÏÉÅÌñ•
                            ctx.globalAlpha = 0.4; 
                        } else {
                            // Ïó∞Ï£º Ï§ë: ÏßÑÌïú ÏõêÏÉâ
                            ctx.globalAlpha = 1.0; 
                        }
                        ctx.fillRect(x, y, keyW - 1, keyHeight);
                        ctx.restore();
                    } else {
                        // ÎÜìÏπú ÎÖ∏Ìä∏ ÌëúÏãú (Îπ®Í∞ÑÏÉâ)
                        const missedNote = notes.find(n => n.note === i && n.scoreStatus === 'missed');
                        if (missedNote) {
                            ctx.save();
                            ctx.fillStyle = COLORS.MISS;
                            ctx.globalAlpha = 1.0;
                            ctx.fillRect(x, y, keyW - 1, keyHeight);
                            ctx.restore();
                        }
                    }

                    // Í±¥Î∞ò ÌÖåÎëêÎ¶¨ Î∞è ÌÖçÏä§Ìä∏
                    ctx.fillStyle = '#000';
                    ctx.fillRect(x + keyW - 1, y, 1, keyHeight); // Íµ¨Î∂ÑÏÑ†
                    
                    ctx.fillStyle = '#000'; // ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ (Ìù∞ Í±¥Î∞ò ÏúÑ Í≤ÄÏùÄ Í∏ÄÏî®)
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(getNoteName(i), x + keyW/2, y + keyHeight - 20);

                    // C Í±¥Î∞ò Ïò•ÌÉÄÎ∏å ÌëúÏãú
                    if (i % 12 === 0) {
                        const octave = (i / 12) - 1; 
                        if (octave >= 1 && octave <= 7) {
                            ctx.fillStyle = '#ff0000';
                            ctx.font = 'bold 11px Arial';
                            ctx.fillText(octave, x + keyW/2, y + keyHeight - 7);
                        }
                    }

                    whiteIndex++;
                }
            }

            // Í≤ÄÏùÄ Í±¥Î∞ò
            whiteIndex = 0;
            for(let i = startNote; i < endNote; i++) {
                if(isWhiteKey(i)) {
                    whiteIndex++;
                } else {
                    const w = keyW * BLACK_KEY_WIDTH_RATIO;
                    const x = (whiteIndex * keyW) - (w / 2);
                    const h = keyHeight * BLACK_KEY_HEIGHT_RATIO;
                    const visual = keyVisuals[i];
                    
                    if (visual) {
                        // [ÏàòÏ†ï] ÎÖ∏Ìä∏Í∞Ä ÌôúÏÑ±Ìôî(Îñ®Ïñ¥Ïßê/ÎàåÎ¶º) ÏÉÅÌÉúÏùº ÎïåÎäî Í≤ÄÏùÄÏÉâ Î≤†Ïù¥Ïä§Î•º Í∑∏Î¶¨ÏßÄ ÏïäÏùå
                        // ÎåÄÏã† ÏÉâÏÉÅÎßå Í∑∏Î†§ÏÑú Î∞ùÍ≤å ÌëúÌòÑ
                        ctx.save();
                        ctx.fillStyle = visual.color;

                        if (visual.status === 1) {
                            // Îñ®Ïñ¥ÏßÄÎäî Ï§ë: Ìù∞ Í±¥Î∞ò ÏúÑÏóê ÎçßÏπ†Ìï¥ÏßÄÎØÄÎ°ú Ìà¨Î™ÖÎèÑÎ•º Ï£ºÎ©¥ ÌååÏä§ÌÖîÌÜ§(ÏòÖÏùÄ ÏÉâ)Ïù¥ Îê®
                            ctx.globalAlpha = 0.5; 
                        } else {
                            // Ïó∞Ï£º Ï§ë: ÏßÑÌïú ÏõêÏÉâ
                            ctx.globalAlpha = 1.0; 
                        }
                        ctx.fillRect(x, y, w, h);
                        ctx.restore();

                        // ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ Ï°∞Ï†ï (Î∞ùÏùÄ Î∞∞Í≤ΩÏóêÏÑúÎäî Í≤ÄÏùÄÏÉâ)
                        ctx.fillStyle = (visual.color === COLORS.YELLOW || visual.color === COLORS.GREEN) ? '#000' : '#fff';
                    } else {
                        // ÌèâÏÜå ÏÉÅÌÉú: Í≤ÄÏùÄÏÉâ Î≤†Ïù¥Ïä§
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x, y, w, h);

                        // ÎÜìÏπú ÎÖ∏Ìä∏ ÌëúÏãú
                        const missedNote = notes.find(n => n.note === i && n.scoreStatus === 'missed');
                        if (missedNote) {
                            ctx.save();
                            ctx.fillStyle = COLORS.MISS;
                            ctx.globalAlpha = 1.0;
                            ctx.fillRect(x, y, w, h);
                            ctx.restore();
                        }
                        
                        // Í∏∞Î≥∏ ÌÖçÏä§Ìä∏ (Ìù∞ÏÉâ)
                        ctx.fillStyle = '#fff';
                    }
                    
                    ctx.font = '10px Arial';
                    const sharpName = getNoteName(i);
                    ctx.fillText(sharpName, x + w/2, y + h - 20); 
                }
            }
            
        }

        // --- 6. Î©îÏù∏ Î°úÏßÅ Î∞è Ï§å ---

        // [ÏàòÏ†ïÎê®] Î™®ÎìúÏóê Îî∞Îùº ÌôîÎ©¥ Ï§ëÏã¨ÏùÑ C3, C4, C5Î°ú Ï†ïÎ†¨ÌïòÎäî Ìï®Ïàò
        function alignViewToMode() {
            const containerWidth = gameWrapper.clientWidth;
            // ÌòÑÏû¨ Ï§å ÏÉÅÌÉúÏóêÏÑúÏùò Í±¥Î∞ò ÌïòÎÇòÏùò ÎÑàÎπÑ Í≥ÑÏÇ∞
            const finalKeyW = logicalWidth / totalWhiteKeys;
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú ÌôïÏù∏
            const chkRight = document.getElementById('chk-right').checked;
            const chkLeft = document.getElementById('chk-left').checked;

            let targetMidi = 60; // Í∏∞Î≥∏: C4 (ÏñëÏÜê ÎòêÎäî Îëò Îã§ Ìï¥Ï†ú Ïãú)

            if (chkRight && !chkLeft) {
                // Ïò§Î•∏ÏÜêÎßå Ïó∞Ïäµ: C5 (72)Í∞Ä Ï§ëÏïô
                targetMidi = 72;
            } else if (!chkRight && chkLeft) {
                // ÏôºÏÜêÎßå Ïó∞Ïäµ: C3 (48)Í∞Ä Ï§ëÏïô
                targetMidi = 48;
            } else {
                // ÏñëÏÜê: C4 (60)Í∞Ä Ï§ëÏïô
                targetMidi = 60;
            }
            
            // ÌÉÄÍ≤ü Í±¥Î∞ò(targetMidi)ÍπåÏßÄÏùò Ìù∞ Í±¥Î∞ò Í∞úÏàò ÏÑ∏Í∏∞
            let targetWhiteKeyIndex = 0;
            for(let i = startNote; i < targetMidi; i++) {
                if(isWhiteKey(i)) targetWhiteKeyIndex++;
            }
            
            // ÌÉÄÍ≤ü Í±¥Î∞òÏùò Ï§ëÏïô X Ï¢åÌëú (Ï†ÑÏ≤¥ Í±¥Î∞ò Ï∫îÎ≤ÑÏä§ Í∏∞Ï§Ä)
            const targetCenterX = (targetWhiteKeyIndex * finalKeyW) + (finalKeyW / 2);
            
            // ÌôîÎ©¥ Ï§ëÏïô(containerWidth / 2)Í≥º ÌÉÄÍ≤ü Í±¥Î∞ò Ï§ëÏïô(targetCenterX)Ïùò Ï∞®Ïù¥
            // offset > 0: ÌÉÄÍ≤üÏù¥ ÌôîÎ©¥ ÏôºÏ™Ω -> ÌîºÏïÑÎÖ∏Î•º Ïò§Î•∏Ï™ΩÏúºÎ°ú Î∞ÄÏñ¥Ïïº Ìï®
            // offset < 0: ÌÉÄÍ≤üÏù¥ ÌôîÎ©¥ Ïò§Î•∏Ï™Ω -> ÌîºÏïÑÎÖ∏Î•º ÏôºÏ™ΩÏúºÎ°ú ÎãπÍ≤®Ïïº Ìï®
            const offset = (containerWidth / 2) - targetCenterX;

            // Ïö∞ÏÑ† ÎßàÏßÑ Ï¥àÍ∏∞Ìôî
            gameContainer.style.marginLeft = '0px';

            if (offset > 0) {
                // ÌîºÏïÑÎÖ∏Î•º Ïò§Î•∏Ï™ΩÏúºÎ°ú Î∞ÄÏñ¥Ïïº Ìï® (Ïä§ÌÅ¨Î°§ÏùÄ 0 Ïù¥ÌïòÎ°ú Í∞à Ïàò ÏóÜÏúºÎØÄÎ°ú margin ÏÇ¨Ïö©)
                gameContainer.style.marginLeft = offset + 'px';
                gameWrapper.scrollLeft = 0;
            } else {
                // ÌîºÏïÑÎÖ∏Î•º ÏôºÏ™ΩÏúºÎ°ú ÎãπÍ≤®Ïïº Ìï® (Ïä§ÌÅ¨Î°§ ÏÇ¨Ïö©)
                const targetScrollLeft = Math.abs(offset);
                gameWrapper.scrollLeft = targetScrollLeft;

                // [Ï§ëÏöî] Ïä§ÌÅ¨Î°§Ïù¥ ÎÅùÏóê ÎèÑÎã¨Ìï¥ÏÑú Îçî Ïù¥ÏÉÅ Í∞à Ïàò ÏóÜÎäî Í≤ΩÏö∞ (Ï§å ÏïÑÏõÉ ÏÉÅÌÉú Îì±)
                // Î∂ÄÏ°±Ìïú ÎßåÌÅº ÎßàÏßÑ(ÏùåÏàò)ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Í∞ïÏ†úÎ°ú Îçî ÎãπÍπÄ
                const currentScroll = gameWrapper.scrollLeft;
                // Î™©Ìëú Ïä§ÌÅ¨Î°§Í≥º Ïã§Ï†ú Ïä§ÌÅ¨Î°§Ïùò Ï∞®Ïù¥Í∞Ä 1px Ïù¥ÏÉÅ ÎÇòÎ©¥ ÌïúÍ≥ÑÏóê ÎèÑÎã¨Ìïú Í≤ÉÏûÑ
                if (Math.abs(currentScroll - targetScrollLeft) > 1) {
                    const missingShift = targetScrollLeft - currentScroll;
                    gameContainer.style.marginLeft = (-missingShift) + 'px';
                }
            }
        }

        function resize() {
            // [ÏµúÏ†ÅÌôî] Î¶¨ÏÇ¨Ïù¥Ï¶à ÏãúÏóêÎèÑ DPR Ï†úÌïú Ï†ÅÏö©
            dpr = Math.min(window.devicePixelRatio || 1, 2);
            const wrapperRect = gameWrapper.getBoundingClientRect();
            
            if (wrapperRect.width === 0) return;

            if (baseWidth === 1000) { 
                baseWidth = wrapperRect.width;
            }

            const containerWidth = baseWidth * (currentZoom / 100);
            gameContainer.style.width = containerWidth + 'px';

            logicalWidth = containerWidth;
            logicalHeight = wrapperRect.height;

            canvas.width = logicalWidth * dpr;
            canvas.height = logicalHeight * dpr; 
            
            ctx.resetTransform();
            ctx.scale(dpr, dpr);
            
            zoomLevelDisplay.innerText = currentZoom + '%';

            // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú Î™®ÎìúÏóê Îî∞Î•∏ Ï†ïÎ†¨ ÏàòÌñâ (ÏàòÏ†ïÎê®)
            alignViewToMode();

            if (!isPlaying) {
                drawKeyboard([]);
            }
        }
        
        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                resize();
            }
        });
        resizeObserver.observe(gameWrapper);
        
        function setZoom(newZoom) {
            if (newZoom < 100) newZoom = 100; 
            if (newZoom > 450) newZoom = 450;

            // Ï§å Î≥ÄÍ≤Ω Î°úÏßÅ (ÏïµÏª§ Ï†úÍ±∞, Ï§ëÏïô Ï†ïÎ†¨ Ïö∞ÏÑ†)
            currentZoom = Math.round(newZoom);
            const newWidth = baseWidth * (currentZoom / 100);
            gameContainer.style.width = newWidth + 'px';
            zoomLevelDisplay.innerText = currentZoom + '%';

            logicalWidth = newWidth;
            logicalHeight = gameWrapper.clientHeight;
            canvas.width = logicalWidth * dpr;
            canvas.height = logicalHeight * dpr;
            ctx.resetTransform();
            ctx.scale(dpr, dpr);

            // Ï§å Î≥ÄÍ≤Ω ÌõÑ Î™®ÎìúÏóê Îî∞Î•∏ Ï†ïÎ†¨ ÏàòÌñâ (ÏàòÏ†ïÎê®)
            alignViewToMode();
            
            if (!isPlaying) {
                drawKeyboard([]);
            }
        }

        function autoFitZoom() {
            if (notes.length === 0) return;

            // ÏûêÎèô Ìïè Î°úÏßÅ (Í∏∞Ï°¥ Ïú†ÏßÄ)
            let minNote = 108;
            let maxNote = 21;
            notes.forEach(n => {
                if (n.note < minNote) minNote = n.note;
                if (n.note > maxNote) maxNote = n.note;
            });

            minNote = Math.max(21, minNote - 2); 
            maxNote = Math.min(108, maxNote + 2);

            let whiteKeysInFull = 0;
            for(let i=startNote; i<endNote; i++) if(isWhiteKey(i)) whiteKeysInFull++;
            const baseKeyWidth = gameWrapper.clientWidth / whiteKeysInFull;

            let whiteKeysInRange = 0;
            for(let i=minNote; i<=maxNote; i++) if(isWhiteKey(i)) whiteKeysInRange++;
            const rangeWidth = whiteKeysInRange * baseKeyWidth;

            const containerWidth = gameWrapper.clientWidth;
            let scale = (containerWidth / rangeWidth) * 0.95;
            let newZoom = scale * 100;

            newZoom = Math.max(100, Math.min(newZoom, 450));
            
            baseWidth = gameWrapper.clientWidth; 
            
            currentZoom = Math.round(newZoom);
            const newTotalWidth = baseWidth * (currentZoom / 100);
            
            gameContainer.style.width = newTotalWidth + 'px';
            zoomLevelDisplay.innerText = currentZoom + '%';
            
            logicalWidth = newTotalWidth;
            logicalHeight = gameWrapper.clientHeight;
            canvas.width = logicalWidth * dpr;
            canvas.height = logicalHeight * dpr;
            ctx.resetTransform();
            ctx.scale(dpr, dpr);

            // Ï§å ÏÑ§Ï†ï ÌõÑ Î™®ÎìúÏóê Îî∞Î•∏ Ï†ïÎ†¨ ÏàòÌñâ (ÏàòÏ†ïÎê®)
            alignViewToMode();
            
            if (!isPlaying) {
                drawKeyboard([]);
            }
        }

        // ÌïÄÏπò Ï§å Ïù¥Î≤§Ìä∏
        let initialPinchDistance = null;
        let initialZoom = 100;

        gameWrapper.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                initialPinchDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                initialZoom = currentZoom;
            }
        }, { passive: false });

        gameWrapper.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2 && initialPinchDistance !== null) {
                e.preventDefault(); 
                const currentDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );

                if (initialPinchDistance > 0) {
                    const scale = currentDistance / initialPinchDistance;
                    const newZoom = initialZoom * scale;
                    setZoom(newZoom); // ÏïµÏª§ ÏóÜÏù¥ Ìò∏Ï∂ú
                }
            }
        }, { passive: false });

        gameWrapper.addEventListener('touchend', (e) => {
            if (e.touches.length < 2) {
                initialPinchDistance = null;
            }
        });

        document.getElementById('btn-zoom-in').addEventListener('click', () => { 
            setZoom(currentZoom + 10);
        });

        document.getElementById('btn-zoom-out').addEventListener('click', () => { 
            setZoom(currentZoom - 10);
        });
        
        zoomLevelDisplay.addEventListener('click', () => { 
            autoFitZoom();
        });

        // Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥ÄÍ≤Ω Ïãú Ï†ïÎ†¨ ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        document.getElementById('chk-right').addEventListener('change', () => {
            alignViewToMode();
        });
        document.getElementById('chk-left').addEventListener('change', () => {
            alignViewToMode();
        });

        // --- 7. Ïò§ÎîîÏò§ Î∞è Í≤åÏûÑ Î£®ÌîÑ ---

        function playTone(freq, duration) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
            osc.stop(audioCtx.currentTime + duration + 0.1);
        }

        function getCurrentTime() {
            if (!isPlaying) return 0;
            return (audioCtx.currentTime - startTime) * speed;
        }

        function loop() {
            if(!isPlaying) return;
            const currentTime = getCurrentTime();
            ctx.clearRect(0, 0, logicalWidth, logicalHeight);
            
            // ÏûêÎèô Ïä§ÌÅ¨Î°§ Ï†úÍ±∞Îê® (Í≥†Ï†ïÎêú ÌôîÎ©¥)
            if (nextNoteIndex < notes.length) {
                // Ïä§ÌÅ¨Î°§ Î°úÏßÅ ÏÇ≠Ï†ú
            }

            // 1. ÎÖ∏Ìä∏ ÏÉÅÌÉú Í≥ÑÏÇ∞ (Active Beams & Key Visuals ÌÜµÌï©)
            const activeBeams = {}; // ÎÖ∏Ìä∏Ïóê ÏùòÌïú ÏãúÍ∞Å Ìö®Í≥º (Îπî + Í±¥Î∞ò)
            const viewHeight = logicalHeight - keyHeight;

            notes.forEach(n => {
                const showRight = document.getElementById('chk-right').checked;
                const showLeft = document.getElementById('chk-left').checked;
                if(n.hand === 'right' && !showRight) return;
                if(n.hand === 'left' && !showLeft) return;

                const timeDiff = n.startTime - currentTime;
                const yTop = viewHeight - (timeDiff * fallingSpeed) - (n.durationTime * fallingSpeed); 
                const yBottom = viewHeight - (timeDiff * fallingSpeed); 
                
                const isPlayingNote = (currentTime >= n.startTime && currentTime < n.startTime + n.durationTime);
                const isFalling = (yBottom > 0 && yTop < viewHeight); 

                // Ïö∞ÏÑ†ÏàúÏúÑ: Ïó∞Ï£º Ï§ë(2) > Îñ®Ïñ¥ÏßÄÎäî Ï§ë(1)
                // Í∞ôÏùÄ ÏÉÅÌÉúÎùºÎ©¥ Î®ºÏ†Ä Ï≤òÎ¶¨Îêú(ÌôîÎ©¥ ÏïÑÎûòÏ™Ω, ÏãúÍ∞ÑÏù¥ Îπ†Î•∏) ÎÖ∏Ìä∏Ïùò ÏÉâÏÉÅÏùÑ Ïú†ÏßÄ
                const newStatus = isPlayingNote ? 2 : (isFalling ? 1 : 0);
                
                if (newStatus > 0) {
                     if (!activeBeams[n.note] || activeBeams[n.note].status < newStatus) {
                        activeBeams[n.note] = { status: newStatus, color: n.color, source: 'note' };
                    }
                }
            });

            // Ï±ÑÏ†ê ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (ÏàòÏ†ïÎê®: Ï≤¥ÌÅ¨Î∞ïÏä§ Ìï¥Ï†úÎêú ÏÜêÏùÄ Miss Ï≤òÎ¶¨ ÏïàÌï®)
            const showRight = document.getElementById('chk-right').checked;
            const showLeft = document.getElementById('chk-left').checked;

            for (let i = nextNoteIndex; i < notes.length; i++) {
                const n = notes[i];
                // ÌòÑÏû¨ ÎÖ∏Ìä∏Í∞Ä ÏÜçÌïú ÏÜêÏù¥ ÌôúÏÑ±Ìôî ÏÉÅÌÉúÏù∏ÏßÄ ÌôïÏù∏
                const isHandActive = (n.hand === 'right' && showRight) || (n.hand === 'left' && showLeft);

                if (currentTime > n.startTime + timingTolerance && !n.played && n.scoreStatus !== 'missed' && n.scoreStatus !== 'ignored') {
                    if (isHandActive) {
                        // ÌôúÏÑ±ÌôîÎêú ÏÜêÏù∏Îç∞ Ïïà Ï≥§ÏúºÎ©¥ Miss Ï≤òÎ¶¨ (Î∂ÑÌôçÏÉâ Î≥ÄÍ≤Ω)
                        n.scoreStatus = 'missed';
                        n.color = COLORS.MISS;
                        score.missed++;
                    } else {
                        // ÎπÑÌôúÏÑ±ÌôîÎêú ÏÜêÏù¥Î©¥ Î¨¥Ïãú (ÏÉâÏÉÅ Î≥ÄÍ≤Ω ÏóÜÏùå)
                        n.scoreStatus = 'ignored';
                    }
                    nextNoteIndex++;
                } else if (currentTime > n.startTime + n.durationTime + 0.5) {
                    nextNoteIndex = i + 1;
                }
            }

            // 2. Î†åÎçîÎßÅ
            drawFullHeightBeams(activeBeams); // Îπî Í∑∏Î¶¨Í∏∞
            
            // Ïò§ÎîîÏò§ Ïû¨ÏÉù
            notes.forEach(n => {
                const playRight = document.getElementById('chk-right').checked;
                const playLeft = document.getElementById('chk-left').checked;
                if(n.hand === 'right' && !playRight) return;
                if(n.hand === 'left' && !playLeft) return;
                
                if (!n.played && currentTime >= n.startTime) {
                    playTone(midiToFreq(n.note), n.durationTime);
                    n.played = true; 
                }
            });

            drawNotes(currentTime); // ÎÖ∏Ìä∏ Î∏îÎü≠ Í∑∏Î¶¨Í∏∞
            
            // 3. Í±¥Î∞ò Î†åÎçîÎßÅ Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©
            // activeBeams(ÎÖ∏Ìä∏ Ìö®Í≥º) + currentPressedNotes(Ïú†Ï†Ä ÏûÖÎ†•)
            const keyVisuals = { ...activeBeams };
            currentPressedNotes.forEach(n => {
                // Ïú†Ï†Ä ÏûÖÎ†•ÏùÄ Ìï≠ÏÉÅ Í∞ÄÏû• Í∞ïÌïú ÏÉÅÌÉú(2)Î°ú ÌëúÏãú, Ïú†Ï†Ä ÏûÖÎ†• ÏÉâÏÉÅ Ïö∞ÏÑ†
                keyVisuals[n.note] = { status: 2, color: n.color || COLORS.CORRECT, source: 'input' };
            });

            drawKeyboard(keyVisuals); // Í±¥Î∞ò Í∑∏Î¶¨Í∏∞
            
            let endTime = songDuration;
            if (currentSection !== null) {
                if (isDefaultSong) {
                    const sectionIdx = parseInt(document.getElementById('sel-section').value);
                    const beatsPerSection = 16; // 4ÎßàÎîî * 4Î∞ïÏûê = 16Î∞ïÏûê
                    const beatDuration = 0.8; // 1Î∞ïÏûêÎãπ 0.8Ï¥à
                    const sectionDuration = beatsPerSection * beatDuration;
                    
                    const sectionStart = sectionIdx * sectionDuration;
                    endTime = sectionStart + sectionDuration + startOffset + 0.1;
                } else {
                    const sectionIdx = parseInt(document.getElementById('sel-section').value);
                    const groupSize = 4;
                    const startMeasureIdx = sectionIdx * groupSize;
                    const endMeasureIdx = Math.min(startMeasureIdx + groupSize, measureTimes.length - 1);
                    if (measureTimes[endMeasureIdx]) {
                        endTime = measureTimes[endMeasureIdx] + startOffset + 0.1; // Íµ¨Í∞Ñ ÎÅù Ïó¨Ïú† ÏãúÍ∞Ñ 1.0Ï¥à -> 0.1Ï¥àÎ°ú Îã®Ï∂ï
                    }
                }
            }
            
            if (currentTime > endTime) {
                handleSongEnd();
                return;
            }
            animationId = requestAnimationFrame(loop);
        }

        function handleSongEnd() {
            const repeatSetting = parseInt(document.getElementById('sel-repeat').value);
            if (currentLoop < repeatSetting) {
                currentLoop++;
                resetPlaybackToSectionStart();
                loop();
            } else {
                stopGame(true); // Í≤åÏûÑÏùÑ ÏôÑÏ†ÑÌûà Ï¥àÍ∏∞ÌôîÌïòÏó¨ Î©îÎâ¥Î°ú Î≥µÍ∑Ä
                statusMsg.innerText = "Ïó∞Ïäµ ÏôÑÎ£å!"; // ÏôÑÎ£å Î©îÏãúÏßÄ ÌëúÏãú
                statusMsg.style.display = 'block';
            }
        }

        function resetPlaybackToSectionStart() {
            const sectionIdx = parseInt(document.getElementById('sel-section').value);
            let loopStartTime = 0;
            
            if (sectionIdx !== -1) {
                if (isDefaultSong) {
                    const beatsPerSection = 16; // 4ÎßàÎîî * 4Î∞ïÏûê = 16Î∞ïÏûê
                    const beatDuration = 0.8; // 1Î∞ïÏûêÎãπ 0.8Ï¥à
                    loopStartTime = sectionIdx * beatsPerSection * beatDuration;
                } else {
                    const startMeasureIdx = sectionIdx * 4;
                    if (startMeasureIdx < measureTimes.length) {
                        loopStartTime = measureTimes[startMeasureIdx];
                    }
                }
            }
            
            const effectiveStartTime = loopStartTime + startOffset;
            
            notes.forEach(n => {
                if (n.startTime < effectiveStartTime) {
                    n.played = true; 
                } else {
                    n.played = false; 
                }
            });

            startTime = audioCtx.currentTime - loopStartTime;
        }

        function updateSectionDropdown() {
            sectionSelect.innerHTML = '<option value="-1">Ï†ÑÍ≥°</option>';
            if (isDefaultSong && currentSongSections.length > 0) {
                currentSongSections.forEach((name, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.text = name;
                    sectionSelect.appendChild(opt);
                });
            } else if (!isDefaultSong && measureTimes.length > 0) {
                // MIDI ÌååÏùº Î°úÎî© Ïãú (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
                const groupSize = 4; 
                const totalMeasures = measureTimes.length - 1;
                const actualLines = Math.ceil(totalMeasures / groupSize);
                const displayLines = Math.max(actualLines, 6);
                
                for(let i=0; i < displayLines; i++) {
                    const opt = document.createElement('option');
                    opt.value = i; 
                    if (i < actualLines) {
                        opt.text = `${i+1}Ïß∏Ï§Ñ`; 
                    } else {
                        opt.text = `${i+1}Ïß∏Ï§Ñ (ÏóÜÏùå)`;
                        opt.disabled = true;
                    }
                    sectionSelect.appendChild(opt);
                }
            }
        }

        function playGame() {
            if (notes.length === 0) {
                loadDefaultSong();
                return;
            }

            if(!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.5;
                masterGain.connect(audioCtx.destination);
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();

            controlsDiv.classList.add('hidden-controls');

            const sectionIdx = parseInt(document.getElementById('sel-section').value);
            currentSection = (sectionIdx === -1) ? null : sectionIdx;

            if (isPaused) {
                isPaused = false;
                isPlaying = true;
                const now = audioCtx.currentTime;
                startTime += (now - pauseTime);
                
                playBtn.innerText = "‚è∏ ÏùºÏãúÏ†ïÏßÄ";
                statusMsg.style.display = 'none';
                loop();
            } else {
                if(isPlaying) return;
                
                speed = parseFloat(document.getElementById('rng-speed').value);
                resetPlaybackToSectionStart();
                
                isPlaying = true;
                isPaused = false;
                playBtn.innerText = "‚è∏ ÏùºÏãúÏ†ïÏßÄ";
                statusMsg.style.display = 'none';
                loop();
            }
        }

        function pauseGame() {
            if (!isPlaying) return;
            isPlaying = false;
            isPaused = true;
            cancelAnimationFrame(animationId);
            pauseTime = audioCtx.currentTime;
            playBtn.innerText = "‚ñ∂ Ïû¨ÏÉù";
            statusMsg.innerText = "ÏùºÏãúÏ†ïÏßÄÎê®\n(ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌïòÎ©¥ Îã§Ïãú ÏãúÏûëÎê©ÎãàÎã§)";
            statusMsg.style.display = 'block';
            // controlsDiv.classList.remove('hidden-controls'); // Î©îÎâ¥ ÌëúÏãú Ï†úÍ±∞
        }

        function stopGame(fullReset = true) {
            isPlaying = false;
            isPaused = false;
            cancelAnimationFrame(animationId);
            playBtn.innerText = "‚ñ∂ Ïû¨ÏÉù";
            if(fullReset) {
                notes.forEach(n => { 
                    n.played = false; 
                    n.scoreStatus = 'pending'; 
                    // ÏÉâÏÉÅ Ï¥àÍ∏∞Ìôî Ïãú ÏôºÏÜê/Ïò§Î•∏ÏÜê Íµ¨Î∂Ñ Ï†ÅÏö©
                    if (n.hand === 'left') {
                        n.color = LEFT_FINGER_COLOR_MAP[n.finger] || '#888';
                    } else {
                        n.color = FINGER_COLOR_MAP[n.finger] || '#888';
                    }
                });
                nextNoteIndex = 0;
                score = { correct: 0, missed: 0, total: 0 };
                
                statusMsg.innerText = notes.length > 0 ? "Ïû¨ÏÉù Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏãúÏûëÌïòÏÑ∏Ïöî" : "MIDI ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî";
                statusMsg.style.display = 'block';
                currentLoop = 0;
                
                ctx.clearRect(0, 0, logicalWidth, logicalHeight);
                drawKeyboard([]); // ÌòÑÏû¨ ÎàåÎ¶∞ ÌÇ§Îßå Í∑∏Î¶º (Ï¥àÍ∏∞Ìôî ÏÉÅÌÉú)
            }
            controlsDiv.classList.remove('hidden-controls');
        }

        playBtn.addEventListener('click', () => { isPlaying ? pauseGame() : playGame(); });
        document.getElementById('btn-stop').addEventListener('click', () => stopGame(true));
        
        speedRange.addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            speedText.innerText = speed.toFixed(1) + 'x';
        });
        document.getElementById('sel-repeat').addEventListener('change', (e) => loopCount = parseInt(e.target.value));
        sectionSelect.addEventListener('change', () => stopGame(true));
        
        // ÌÅ¥Î¶≠/ÎçîÎ∏îÌÅ¥Î¶≠ Íµ¨Î∂Ñ Î°úÏßÅ Ï∂îÍ∞Ä
        let clickTimeout = null;

        document.addEventListener('click', (e) => {
            if (e.target.closest('#controls')) return;
            
            if (clickTimeout) {
                // ÌÉÄÏù¥Î®∏Í∞Ä ÎèåÏïÑÍ∞ÄÎäî Ï§ëÏóê Îã§Ïãú ÌÅ¥Î¶≠Îê® -> ÎçîÎ∏î ÌÅ¥Î¶≠ÏúºÎ°ú Í∞ÑÏ£º
                clearTimeout(clickTimeout);
                clickTimeout = null;
                stopGame(true); // Í≤åÏûÑ Ï§ëÎã® Î∞è Î©îÏù∏ ÌôîÎ©¥ Î≥µÍ∑Ä
            } else {
                // Ï≤´ Î≤àÏß∏ ÌÅ¥Î¶≠ -> ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï
                clickTimeout = setTimeout(() => {
                    clickTimeout = null;
                    // Ïã±Í∏Ä ÌÅ¥Î¶≠ ÎèôÏûë Ïã§Ìñâ (250ms ÎèôÏïà Ï∂îÍ∞Ä ÌÅ¥Î¶≠ ÏóÜÏúºÎ©¥)
                    isPlaying ? pauseGame() : playGame();
                }, 250); // ÎçîÎ∏î ÌÅ¥Î¶≠ Í∞ÑÍ≤© Í∞êÏßÄ ÏãúÍ∞Ñ (0.25Ï¥à)
            }
        });

        // Ï¥àÍ∏∞Ìôî
        loadDefaultSong();
        resize(); 
        
        // Ï¥àÍ∏∞ ÏÉÅÌÉú Í±¥Î∞ò Í∑∏Î¶¨Í∏∞ (Îπà ÏÉÅÌÉú)
        drawKeyboard([]);
    </script>
</body>
</html>